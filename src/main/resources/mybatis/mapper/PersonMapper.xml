<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ts.cpfr.dao.PersonDao">
	<select id="selectPerson" parameterType="pd" resultType="pd">
		SELECT p.person_id,p.person_name,p.emp_number,p.add_time,i.blob_image base_image from tbl_#{wid}_person p left join tbl_#{wid}_image i on p.image_id=i.image_id where p.person_id=#{person_id} and p.status &lt;&gt; 3
	</select>

	<select id="selectPersonList" parameterType="pd" resultType="pd">
		select person_id,person_name,emp_number,add_time,image_id from tbl_#{wid}_person where status &lt;&gt; 3
		<if test="group_id!=null and group_id!=''">
			and group_id=#{group_id}
		</if>
	</select>

	<select id="selectPersonListWithBlob" parameterType="pd" resultType="pd">
		select p.person_id,p.person_name,p.emp_number,p.add_time,i.blob_image base_image from tbl_#{wid}_person p left join tbl_#{wid}_image i on p.image_id=i.image_id
		where p.status &lt;&gt; 3
		<if test="group_id!=null and group_id!=''">
			and p.group_id=#{group_id}
		</if>
        <if test="keyword!=null and keyword!=''">
            and POSITION(#{keyword} IN p.person_name) OR POSITION(#{keyword} IN p.emp_number)
        </if>

	</select>

	<insert id="insertPerson" parameterType="pd">
		insert into tbl_#{wid}_image (blob_image) values (#{blob_image});
		INSERT INTO tbl_#{wid}_person(person_name,emp_number,status,add_time,image_id) VALUES(#{person_name},#{emp_number},1,now(),(select LAST_INSERT_ID()));
	</insert>

	<update id="updatePersonGroupID" parameterType="pd">
		UPDATE tbl_#{wid}_person SET group_id = #{group_id}  WHERE
		<foreach collection="list" item="data" separator=" or ">
			person_id=#{data.person_id}
		</foreach>
	</update>

	<select id="selectImage" parameterType="pd" resultType="pd">
		SELECT blob_image FROM tbl_#{wid}_image WHERE image_id=#{image_id}
	</select>

	<select id="selectGrantPersonListByDeviceSn" parameterType="pd" resultType="pd">
		SELECT p.person_id,p.person_name,p.emp_number,p.status,p.lmt,g.grant_id,g.pass_number,g.pass_start_time,g.pass_end_time FROM tbl_#{wid}_person p RIGHT JOIN (SELECT grant_id,person_id,pass_number,pass_start_time,pass_end_time FROM tbl_#{wid}_grant WHERE device_id = (SELECT device_id FROM tbl_#{wid}_device  WHERE device_sn = #{device_sn}) and status &lt;&gt; 3 ) g ON p.person_id=g.person_id
		<where>
			<if test="keyword!=null and keyword!=''">
				and POSITION(#{keyword} IN p.person_name) OR POSITION(#{keyword} IN p.emp_number)
			</if>
		</where>
	</select>


	<update id="updatePersonInfo" parameterType="pd">
		UPDATE tbl_#{wid}_person SET person_name = #{person_name},emp_number = #{emp_number},status = 2 where person_id=#{person_id};
	</update>

	<delete id="deletePerson" parameterType="pd">
		update tbl_#{wid}_person set status=3 where person_id = #{person_id};
	</delete>
</mapper>