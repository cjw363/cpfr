<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ts.cpfr.dao.DeviceDao">
	<select id="selectDevice" parameterType="pd" resultType="pd">
		select d.device_id,d.device_name,d.device_sn,d.mac_grant_key,d.online,d.register_time,d.activate_time,d.last_online_time,d.last_offine_time,c.open_door_type,c.success_msg,c.fail_msg
		 from tbl_#{wid}_device d left join tbl_#{wid}_device_config c on d.device_id=c.device_id where d.device_sn=#{device_sn}
	</select>

	<select id="selectDeviceList" parameterType="pd" resultType="pd">
		select device_id,device_name,device_sn,online,status,register_time,activate_time,last_online_time,last_offine_time from tbl_#{wid}_device
		<where>
			<if test="group_id!=null and group_id!=''">
				group_id=#{group_id}
			</if>
		</where>
	</select>

	<select id="selectInActDevice" parameterType="pd" resultType="pd">
		select device_sn,status,online,register_time,activate_time,mac_grant_key from tbl_inact_device where device_sn=#{device_sn}
	</select>

	<select id="selectInActDeviceList" parameterType="pd" resultType="pd">
		select id,device_sn device_name,status,online,register_time from tbl_inact_device where status=0
	</select>

	<update id="updateInActDeviceOnline" parameterType="pd">
		UPDATE tbl_inact_device SET online = #{online} WHERE device_sn=#{device_sn}
	</update>

	<update id="updateDeviceOnline" parameterType="pd">
		UPDATE tbl_#{wid}_device SET online = #{online}
		<if test="online==1 or online=='1'">
			,last_online_time=now()
		</if>
		<if test="online==0 or online=='0'">
			,last_offine_time=now()
		</if>
		WHERE device_sn=#{device_sn}
	</update>

	<insert id="insertDevice" parameterType="pd">
		UPDATE tbl_inact_device SET mac_grant_key = #{mac_grant_key},status=1,admin_id=#{admin_id},activate_time=now() WHERE device_sn=#{device_sn};

		INSERT INTO tbl_#{wid}_device (device_name,device_sn,last_online_time,mac_grant_key,register_time,activate_time,online) select device_sn,device_sn,now(),mac_grant_key,register_time,activate_time,online from tbl_inact_device where device_sn=#{device_sn};

		INSERT INTO tbl_#{wid}_device_config (device_id) select device_id from tbl_#{wid}_device where device_sn=#{device_sn};
	</insert>

	<update id="updateDeviceGroupID" parameterType="pd">
		UPDATE tbl_#{wid}_device SET group_id = #{group_id} WHERE
		<foreach collection="list" item="data" separator=" or ">
			device_id=#{data.device_id}
		</foreach>
	</update>

	<select id="selectDeviceSnList" parameterType="pd" resultType="pd">
		select device_sn from tbl_#{wid}_device where
		<foreach collection="list" item="data" separator=" or ">
		    device_id=#{data.device_id}
		</foreach>
	</select>

	<update id="updateDeviceInfo" parameterType="pd">
		UPDATE tbl_#{wid}_device SET device_name = #{device_name} where device_sn=#{device_sn};

		UPDATE tbl_#{wid}_device_config SET open_door_type = #{open_door_type},success_msg=#{success_msg},fail_msg=#{fail_msg} where device_id=(select device_id from tbl_#{wid}_device where device_sn=#{device_sn});
	</update>

	<select id="selectAccessDeviceListByPersonId" parameterType="pd" resultType="pd">
		SELECT d.device_id,d.device_name,g.pass_number,g.pass_start_time,g.pass_end_time FROM tbl_#{wid}_device d inner JOIN (SELECT device_id,pass_number,pass_start_time,pass_end_time FROM tbl_#{wid}_grant WHERE person_id = #{person_id})g ON g.device_id=d.device_id
	</select>

	<delete id="deleteDeviceByDeviceID" parameterType="pd">
		DELETE d,c FROM tbl_#{wid}_device d LEFT JOIN tbl_#{wid}_device_config c ON d.device_id=c.device_id WHERE d.device_id=#{device_id};

		DELETE g,p,i FROM tbl_#{wid}_grant g LEFT JOIN tbl_#{wid}_person p ON g.person_id=p.person_id LEFT JOIN tbl_#{wid}_image i ON p.image_id=i.image_id WHERE g.device_id=#{device_id};

		UPDATE tbl_inact_device SET status=0,mac_grant_key=NULL,admin_id=NULL,activate_time=NULL WHERE device_sn=(SELECT device_sn FROM tbl_#{wid}_device WHERE device_id = #{device_id})
	</delete>
</mapper>